<!DOCTYPE html>
<html>
<head>
    <title>Barcode Scanner</title>
</head>
<body>
    <input type="file" accept="image/*" capture="environment" id="cameraInput">
    <button id="scanButton" style="visibility: hidden;">Scan Again</button>
    <div id="barcodeResult"></div>
    <button id="confirm" style="visibility: hidden;">Confirm</button>
    <div id="bookDetails">
        <div id="bookname"></div>
        <div id="authorname"></div>
        <div id="genrename"></div>
        <div id="yearofpublish"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script>
        var apiKey = 'AIzaSyA04MfGxy' + 'cBuwJ0Oq' + 'IL2x_6JsKoJCDU7gk';
        let scanButton = document.querySelector('#scanButton');
        let barcodeResult = document.querySelector('#barcodeResult');
        let cameraInput = document.querySelector('#cameraInput');
        let confirm = document.querySelector('#confirm');

        document.addEventListener('DOMContentLoaded', () => {

            cameraInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        Quagga.decodeSingle({
                            src: e.target.result,
                            numOfWorkers: 0,  // Needs to be 0 when used with decodeSingle
                            decoder: {
                                readers: ["ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader"]
                            }
                        }, function (result) {
                            if (result && result.codeResult) {
                                console.log("Barcode detected and decoded: ", result.codeResult.code);

                                var thecode = result.codeResult.code;

                                localStorage.setItem('isbn', thecode);

                                barcodeResult.innerHTML = localStorage.getItem('isbn');

                                scanButton.style.visibility = 'visible';
                                scanButton.style.marginTop = '1vh';
                                confirm.style.visibility = 'visible';
                            } else {
                                console.log("Barcode not detected.");
                            }
                        });
                    };
                    reader.readAsDataURL(file);
                }
            });

            scanButton.addEventListener('click', () => {
                cameraInput.click();
            });

            window.addEventListener('beforeunload', function () {
                Quagga.stop();
            });
        });

        var isbn = localStorage.getItem('isbn');
        const apiUrl = `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbn}&key=${apiKey}`;

        confirm.addEventListener('click', () => {
            var node = document.getElementById('barcodeResult');
            codess = node.textContent;
            var apiUrl = 'https://www.googleapis.com/books/v1/volumes?q=isbn:' + codess + '&key=' + apiKey;

            fetch(apiUrl)
                .then(response => {
                    if (!response.ok) {
                        alert('Network response was not ok');
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    bookdata(data);
                })
                .catch(error => {
                    alert('There was a problem with the fetch operation');
                    console.error('Fetch error:', error);
                });
        });

        var bookname = document.querySelector('#bookname');
        var authorname = document.querySelector('#authorname');
        var genrename = document.querySelector('#genrename');
        var yearofpublish = document.querySelector('#yearofpublish');

        function bookdata(data) {
            window.scrollTo(0, document.body.scrollHeight);
            const book = data.items[0];
            bookname.innerHTML = book.volumeInfo.title;

            const authors = book.volumeInfo.authors;
            var authortext = authors ? authors.join(',') : 'unknown';
            authorname.innerHTML = authortext;

            const categories = book.volumeInfo.categories;
            var category = categories ? categories.join(',') : 'unknown';
            genrename.innerHTML = category;

            yearofpublish.innerHTML = book.volumeInfo.publishedDate;
        }
    </script>
</body>
</html>
